# CFDL Engine

Julia-based execution engine for the Cash Flow Definition Language (CFDL).

## Overview

The CFDL Engine processes Intermediate Representation (IR) files generated by the Java compilation pipeline to produce cash flow analyses, financial metrics, and distribution waterfalls using Monte Carlo simulation.

## Features

✅ **Monte Carlo Orchestration**: Supports both deterministic (1 trial) and stochastic (N trials) execution  
✅ **Stochastic Parameter Sampling**: Handles Normal, Uniform, LogNormal distributions and Random Walk processes  
✅ **Temporal Grid Generation**: Daily, weekly, monthly, quarterly, annual frequencies with business day conventions  
✅ **Business Day Handling**: US/UK holiday calendars with following/preceding/modified-following conventions  
✅ **Day Count Conventions**: Actual/365, Actual/360, 30/360, Actual/Actual support  
✅ **Seed Management**: Reproducible results with unique seeds per trial  
✅ **IR JSON Loading**: Flexible parsing of compilation pipeline output  
✅ **Comprehensive Testing**: Full unit test coverage with 98 passing tests  

## Architecture

```
IR JSON → Monte Carlo Harness → [Grid → Allocation → Aggregation → Metrics → Waterfall] → Results
```

### Current Implementation Status

- ✅ **Monte Carlo Harness** (Sub-task 2.1): Complete trial orchestration framework
- ✅ **Temporal Grid Generator** (Sub-task 2.2): Complete time period generation with all frequencies
- ⏳ **Stream Allocator** (Sub-task 2.3): Pending implementation
- ⏳ **Cash-Flow Aggregator** (Sub-task 2.4): Pending implementation
- ⏳ **Metrics Library** (Sub-task 2.5): Pending implementation
- ⏳ **Waterfall Distributor** (Sub-task 2.6): Pending implementation

## Quick Start

### Installation

```bash
cd engine
julia --project=. -e "using Pkg; Pkg.instantiate()"
```

### Running Tests

```bash
julia --project=. test/runtests.jl
```

### Demo

```bash
julia demo.jl
```

## Usage Example

```julia
using CFDLEngine

# Load IR file
ir_data = load_ir("path/to/ir_file.json")

# Create engine
engine = MonteCarloEngine(ir_data)

# Run deterministic simulation
result = run_monte_carlo(engine, 1)

# Run stochastic simulation  
result = run_monte_carlo(engine, 1000)

# Save results
save_results(result, "output.json")
```

## Stochastic Parameter Support

The engine automatically detects and samples stochastic parameters defined in the IR:

**Fixed Parameters**:
```json
{"interest_rate": 0.045}
```

**Distribution Parameters**:
```json
{
  "rent_growth": {
    "type": "Normal",
    "mean": 0.03,
    "std": 0.01
  }
}
```

**Random Walk Parameters**:
```json
{
  "inflation": {
    "type": "RandomWalk", 
    "initial_value": 0.025,
    "drift": 0.001,
    "volatility": 0.005
  }
}
```

## Performance

- **100 trials**: ~0.12 seconds (including temporal grid generation)
- **Test suite**: 98 tests pass in ~19.3 seconds
- **Memory efficient**: Statically-sized arrays and minimal allocations
- **Temporal grid**: Supports 10,000+ periods with safety limits

## Development

### Adding New Distribution Types

1. Add new case to `parse_parameter_definition()` in `ir_loader.jl`
2. Implement sampling in `sample_parameter()` in `sampling.jl`  
3. Add validation in `validate_parameter()` in `ir_loader.jl`
4. Add tests in `test_monte_carlo.jl`

### Next Steps

The next sub-task is **Stream Allocator** (2.3) which will:
- Allocate stream cash flows to temporal grid periods
- Apply growth factors and logic block overrides  
- Support real options for dynamic model modification
- Provide foundation for hierarchical cash flow aggregation

---

*This is Sub-tasks 2.1-2.2 of the CFDL Engine implementation. See `/docs/engine-design.md` for complete architecture documentation.*